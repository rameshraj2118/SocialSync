<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SocialSync Trends</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='trends.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='user-preferences.css') }}">
  <script src="{{ url_for('static', filename='user-preferences.js') }}" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header class="top-nav">
    <div class="nav-left">
      <div class="logo">
        <img src="static/images/logo.png" alt="SocialSync Logo">
      </div>
      <ul class="menu">
        <li><a href="{{ url_for('home') }}">Home</a></li>
        <li><a href="{{ url_for('explore') }}">Explore</a></li>
        <li><a href="{{ url_for('live') }}">Live</a></li>
        <li><a href="{{ url_for('trends') }}">Trends</a></li>
        <li>Notifications</li>
        <img class="avatar" src="static/images/pfp.jpg" alt="img">
      </ul>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div>
        <div class="user-info">
          <p class="username">{{ session.username }}</p>
          <p class="handle">@{{ session.handle }}</p>
        </div>
        <nav>
          <ul>
            <a href="{{ url_for('home') }}"><li><i class="fa-solid fa-chart-simple"></i> Analytics</li></a>
            <a href="{{ url_for('post') }}"><li><i class="fa-solid fa-plus"></i> Posts</li></a>
            <a href="{{ url_for('schedule') }}"><li><i class="fa-solid fa-calendar-days"></i> Schedule</li></a>
            <a href="{{ url_for('ads') }}"><li><i class="fa-solid fa-bullhorn"></i> Ads</li></a>
            <a href="{{ url_for('inbox') }}"><li><i class="fa-regular fa-comment-dots"></i> Inbox</li></a>
            <a href="{{ url_for('settings') }}"><li><i class="fa-solid fa-gear"></i> Settings</li></a>
          </ul>
        </nav>
      </div>
      <a href="{{ url_for('login') }}"><button class="logout-btn">Log Out</button></a>
    </aside>

    <main class="main">
      <section class="content">
        <h1 class="aly">Trends</h1>
        <p class="subtext">Trending Now</p>

        <div class="trend-header">
          <p id="trendSource">Loading trends...</p>
          <button id="refreshTrendsBtn" class="refresh-btn" type="button">
            <i class="fa-solid fa-rotate"></i> Refresh
          </button>
        </div>

        <div id="trendingCreatorsGrid" class="trending-grid">
          <p class="empty">Fetching creator trends...</p>
        </div>
      </section>
    </main>
  </div>

  <script>
    function formatFollowers(count) {
      const num = Number(count || 0);
      if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
      if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
      return `${num}`;
    }

    function renderCreators(creators) {
      const grid = document.getElementById("trendingCreatorsGrid");
      if (!creators || !creators.length) {
        grid.innerHTML = "<p class='empty'>No trend data available.</p>";
        return;
      }

      grid.innerHTML = creators.map((creator) => `
        <article class="trend-card">
          <div class="creator-top">
            <img src="${creator.avatar_url}" alt="${creator.name}">
            <div>
              <h3>${creator.name}</h3>
              <p>@${creator.username}</p>
            </div>
          </div>

          <p class="bio">${creator.bio || ""}</p>

          <div class="creator-stats">
            <span class="pill score-pill">Trend ${creator.score || 0}</span>
            <span class="pill platform-pill">${creator.platform || "Creator"}</span>
            <span class="pill follow-pill">${formatFollowers(creator.followers)} followers</span>
          </div>

          <a class="profile-link" href="${creator.profile_url || '#'}" target="_blank" rel="noopener noreferrer">
            View profile <i class="fa-solid fa-arrow-up-right-from-square"></i>
          </a>
        </article>
      `).join("");
    }

    async function loadTrends() {
      const sourceEl = document.getElementById("trendSource");
      sourceEl.textContent = "Loading trends...";
      try {
        const res = await fetch("/api/trends/creators");
        if (!res.ok) throw new Error("Failed to load trends");
        const data = await res.json();
        renderCreators(data.creators || []);
        sourceEl.textContent = `Source: ${data.source || "unknown"}`;
      } catch (err) {
        sourceEl.textContent = "Source unavailable";
        document.getElementById("trendingCreatorsGrid").innerHTML = "<p class='empty'>Could not load trends right now.</p>";
      }
    }

    document.getElementById("refreshTrendsBtn").addEventListener("click", loadTrends);
    loadTrends();
  </script>
</body>
</html>
