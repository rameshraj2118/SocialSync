<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SocialSync Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='home.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='user-preferences.css') }}">
  <script src="{{ url_for('static', filename='user-preferences.js') }}" defer></script>
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- NAVBAR / HEADER -->
  <header class="top-nav">
    <div class="nav-left">
      <!-- Logo inside navbar -->
      <div class="logo">
        <img src="static/images/logo.png" alt="SocialSync Logo">
      </div>
      <ul class="menu">
        <li class="menu-list"><a href="{{ url_for('home') }}">Home</a></li>
        <li class="menu-list"><a href="{{ url_for('explore') }}">Explore</a></li>
        <li class="menu-list"><a href="{{ url_for('live') }}">Live</a></li>
        <li class="menu-list"><a href="{{ url_for('trends') }}">Trends</a></li>
        <li class="menu-list notification-menu-item" data-notification-trigger="true">Notifications</li>
        <img class="avatar" src="static/images/pfp.jpg" alt="img">
      </ul>
    </div>
  </header>

  <!-- MAIN LAYOUT -->
  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div>
        <div class="user-info">
          <p class="username">{{ session.username }}</p>
          <p class="handle">@{{ session.handle }}</p>
        </div>
        <nav>
          <ul>
            <a href="{{ url_for('home') }}"><li class="active"><i class="fa-solid fa-chart-simple"></i> Analytics</li></a>
            <a href="{{ url_for('post') }}"><li><i class="fa-solid fa-plus"></i>Posts</li></a>
            <a href="{{ url_for('schedule') }}"><li><i class="fa-solid fa-calendar-days"></i> Schedule</li></a>
            <a href="{{ url_for('ads') }}"><li><i class="fa-solid fa-bullhorn"></i> Ads</li></a>
            <a href="{{ url_for('inbox') }}"><li><i class="fa-regular fa-comment-dots"></i> Inbox</li></a>
            <a href="{{ url_for('settings') }}"><li><i class="fa-solid fa-gear"></i> Settings</li></a>
          </ul>
        </nav>
      </div>
      <a href="{{ url_for('login') }}"><button class="logout-btn">Log Out</button></a>
    </aside>

    <!-- CONTENT -->
    <main class="main">
      <section class="content">
        <h1 class="aly">Analytics</h1>
        <p class="subtext">This is your dashboard for the last 30 days.</p>

        <div class="tabs">
          <button class="active">Instagram</button>
          <a href="{{ url_for('youtube') }}"><button>YouTube</button></a>
          <a href="{{ url_for('facebook') }}"><button>Facebook</button></a>
          <a href="{{ url_for('twitter') }}"><button>Twitter</button></a>
        </div>

        <div class="stats-grid">
          <div class="stat-box">
            <p>Followers</p>
            <h2>
              <span id="followers">0</span>
              <span id="followers-change">0</span>
            </h2>
          </div>

          <div class="stat-box">
            <p>Impressions</p>
            <h2>
              <span id="impressions">0</span>
              <span id="impressions-change">0</span>
            </h2>
          </div>

          <div class="stat-box">
            <p>Engagement rate</p>
            <h2>
              <span id="engagement">0</span>%
              <span id="engagement-change">0%</span>
            </h2>
          </div>

          <div class="stat-box">
            <p>Likes</p>
            <h2>
              <span id="likes">0</span>
              <span id="likes-change">0</span>
            </h2>
          </div>
        </div>

        <div class="charts-grid">
          <div class="chart-box">
              <p>Impressions</p>
              <h2><span id="impressions-value">0</span> impressions</h2>
              <canvas id="impressionsChart"></canvas>
            </div>
          <div class="chart-box">
            <p>Followers Gained</p>
            <h2><span id="followers-value">0</span> followers</h2>
            <canvas id="followersChart"></canvas>
          </div>
        </div>
      </section>
    </main>
  </div>
  <script>
let impressionsChart = null;
let followersChart = null;

async function loadAnalytics() {
  const res = await fetch("/api/instagram/analytics");
  const data = await res.json();

  document.querySelector("#followers-value").innerText = data.followers;
  document.querySelector("#impressions-value").innerText = data.impressions;

  impressionsChart = renderChart("impressionsChart", data.labels, data.impressions_graph, impressionsChart);
  followersChart = renderChart("followersChart", data.labels, data.followers_graph, followersChart);
}

function renderChart(canvasId, labels, values, existingChart) {
  if (existingChart) existingChart.destroy();

  const ctx = document.getElementById(canvasId).getContext("2d");
  const gradient = ctx.createLinearGradient(0, 0, 0, 300);
  gradient.addColorStop(0, "rgba(236,72,153,0.45)");
  gradient.addColorStop(1, "rgba(236,72,153,0)");

  return new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        data: values,
        borderColor: "#ec4899",
        backgroundColor: gradient,
        fill: true,
        borderWidth: 3,
        tension: 0.4,
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        x: { grid: { display: false } },
        y: { grid: { color: "rgba(255,255,255,0.05)" } }
      }
    }
  });
}
async function loadData() {
  const res = await fetch("/api/analytics");
  const data = await res.json();

  updateBox("followers", "followers-change", data.followers, data.followers_change);
  updateBox("impressions", "impressions-change", data.impressions, data.impressions_change);
  updateBox("engagement", "engagement-change", data.engagement_rate, data.engagement_change, "%");
  updateBox("likes", "likes-change", data.likes, data.likes_change);
}

function updateBox(valueId, changeId, value, change, suffix="") {
  document.getElementById(valueId).innerText = value;

  const changeEl = document.getElementById(changeId);
  changeEl.innerText = (change >= 0 ? "+" : "") + change + suffix;

  // set color
  changeEl.classList.remove("positive", "negative");
  changeEl.classList.add(change >= 0 ? "positive" : "negative");
}

loadData();
setInterval(loadAnalytics, 10000);
loadAnalytics();
</script>
</body>
</html>




