<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SocialSync Posts</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='post.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- NAVBAR -->
  <header class="top-nav">
    <div class="nav-left">
      <div class="logo">
        <img src="static/images/logo.png" alt="SocialSync Logo">
      </div>
      <ul class="menu">
        <li>Home</li>
        <li>Explore</li>
        <li>Live</li>
        <li>Trends</li>
        <li>Notifications</li>
      </ul>
    </div>
    <div class="avatar"></div>
  </header>

  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div>
        <div class="user-info">
          <p class="username">{{ session.username }}</p>
<p class="handle">@{{ session.handle }}</p>

        </div>
        <nav>
          <ul>
            <a href="{{ url_for('home') }}"><li><i class="fa-solid fa-chart-simple"></i> Analytics</li></a>
            <a href="{{ url_for('post') }}"><li class="active"><i class="fa-solid fa-plus"></i> Posts</li></a>
            <a href="{{ url_for('schedule') }}"><li><i class="fa-solid fa-calendar-days"></i> Schedule</li></a>
            <a href="{{ url_for('ads') }}"><li><i class="fa-solid fa-bullhorn"></i> Ads</li></a>
            <a href="{{ url_for('inbox') }}"><li><i class="fa-regular fa-comment-dots"></i> Inbox</li></a>
            <a href="{{ url_for('settings') }}"><li><i class="fa-solid fa-gear"></i> Settings</li></a>
          </ul>
        </nav>
      </div>
      <a href="{{ url_for('login') }}"><button class="logout-btn">Log Out</button></a>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">
      <section class="content">
        <h1 class="aly">Posts</h1>
        <p class="subtext">Manage and view your posts</p>

        <!-- 'TABS
        <div class="tabs">
          <button class="active">Instagram</button>
          <a href="{{ url_for('youtube') }}"><button>YouTube</button></a>
          <button>Facebook</button>
          <button>Twitter</button>
        </div>' -->

        <!-- Recent Posts -->
        <div class="posts-section">
          <div class="posts-header">
            <h3>Recent Posts</h3>
            <button class="new-btn" onclick="openPostModal()">
  <i class="fa-solid fa-plus"></i> New Post
</button>

          </div>
          <div class="posts-grid" id="recentPostsGrid"></div>
        </div>

        <!-- Top Posts -->
        <div class="posts-section">
          <h3>Top Posts</h3>
          <div class="posts-grid" id="topPostsGrid"></div>
        </div>

      </section>
    </main>
  </div>
  <!-- CREATE POST MODAL -->
<div class="modal-overlay" id="postModal">
  <div class="modal">

    <div class="modal-header">
      <h2>Create New Post</h2>
      <span class="close-btn" onclick="closePostModal()">&times;</span>
    </div>

    <!-- PLATFORM SELECTION -->
    <div class="modal-section">
      <h4>Select Platforms</h4>
      <div class="platform-boxes">
        <div class="platform-box active">
          <i class="fab fa-instagram"></i>
          <span>Instagram</span>
        </div>
        <div class="platform-box">
          <i class="fab fa-facebook"></i>
          <span>Facebook</span>
        </div>
        <div class="platform-box">
          <i class="fab fa-twitter"></i>
          <span>Twitter</span>
        </div>
        <div class="platform-box">
          <i class="fab fa-youtube"></i>
          <span>YouTube</span>
        </div>
      </div>
    </div>

    <!-- POST CONTENT -->
    <form id="postForm">

      <div class="modal-section">
        <h4>Post Content</h4>
        <textarea name="caption" placeholder="Write your caption..."></textarea>
        <input type="file" name="image" id="imageUpload" accept="image/*">
      </div>

    </form>

    <!-- ACTION BUTTONS -->
    <div class="modal-actions">
      <button class="draft-btn" onclick="fakeAction('draft')">Save Draft</button>
      <button class="publish-btn" onclick="fakeAction('post')">Post Now</button>
    </div>
    <p class="action-status" id="actionStatus"></p>

  </div>
</div>
<!-- DELETE CONFIRMATION MODAL -->
<div class="modal-overlay" id="deleteModal">
  <div class="modal confirm-modal">
    <div class="modal-header">
      <h2>Delete Post</h2>
      <span class="close-btn" onclick="closeDeleteModal()">&times;</span>
    </div>
    <p class="confirm-text">Are you sure you want to delete this post?</p>
    <div class="confirm-actions">
      <button class="draft-btn" onclick="closeDeleteModal()">Cancel</button>
      <button class="publish-btn danger-btn" onclick="confirmDeletePost()">Delete</button>
    </div>
  </div>
</div>
<script>
let resizedUploadFile = null;
let pendingDeletePostId = null;

// ================= MODAL CONTROL =================
function openPostModal() {
  document.getElementById("postModal").style.display = "flex";
}

function closePostModal() {
  document.getElementById("postModal").style.display = "none";
}

// ================= PLATFORM SELECT =================
document.querySelectorAll(".platform-box").forEach(box => {
  box.addEventListener("click", () => {
    box.classList.toggle("active");
  });
});

// ================= IMAGE INPUT =================
const imageInput = document.getElementById("imageUpload");

if (imageInput) {
  imageInput.addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) {
      resizedUploadFile = null;
      return;
    }

    resizedUploadFile = await resizeImageIfNeeded(file, 1600, 0.85);
  });
}

async function resizeImageIfNeeded(file, maxSize, quality) {
  if (!file.type.startsWith("image/")) {
    return file;
  }

  let imageBitmap;
  try {
    imageBitmap = await createImageBitmap(file);
  } catch (err) {
    return file;
  }
  const originalWidth = imageBitmap.width;
  const originalHeight = imageBitmap.height;
  const scale = Math.min(1, maxSize / Math.max(originalWidth, originalHeight));

  if (scale === 1) {
    imageBitmap.close();
    return file;
  }

  const canvas = document.createElement("canvas");
  canvas.width = Math.round(originalWidth * scale);
  canvas.height = Math.round(originalHeight * scale);

  const ctx = canvas.getContext("2d");
  ctx.drawImage(imageBitmap, 0, 0, canvas.width, canvas.height);
  imageBitmap.close();

  const blob = await new Promise(resolve =>
    canvas.toBlob(resolve, "image/jpeg", quality)
  );

  if (!blob) {
    return file;
  }

  return new File([blob], file.name.replace(/\.\w+$/, ".jpg"), { type: "image/jpeg" });
}

// ================= GET SELECTED PLATFORMS =================
function getSelectedPlatforms() {
  const selected = [];
  document.querySelectorAll(".platform-box.active span").forEach(el => {
    selected.push(el.innerText);
  });
  return selected.join(",");
}

// ================= SAVE / PUBLISH POST =================
async function fakeAction(type) {

  const statusEl = document.getElementById("actionStatus");
  const form = document.getElementById("postForm");

  const formData = new FormData(form);
  if (resizedUploadFile) {
    formData.set("image", resizedUploadFile);
  }
  formData.append("platforms", getSelectedPlatforms());
  formData.append("status", type === "draft" ? "draft" : "published");

  statusEl.style.color = "#1da1f2";
  statusEl.textContent = "Saving...";

  try {
    const res = await fetch("/api/posts", {
      method: "POST",
      body: formData
    });

    if (!res.ok) throw new Error("Failed");

    statusEl.style.color = "#4CAF50";
    statusEl.textContent =
      type === "draft" ? "Draft saved successfully!" : "Post published successfully!";

    // reload posts
    loadPosts();

    // reset form
    form.reset();
    resizedUploadFile = null;

    setTimeout(() => {
      statusEl.textContent = "";
      closePostModal();
    }, 1200);

  } catch (err) {
    statusEl.style.color = "red";
    statusEl.textContent = "Error saving post";
  }
}

function openDeleteModal(postId) {
  pendingDeletePostId = postId;
  document.getElementById("deleteModal").style.display = "flex";
}

function closeDeleteModal() {
  pendingDeletePostId = null;
  document.getElementById("deleteModal").style.display = "none";
}

async function confirmDeletePost() {
  if (!pendingDeletePostId) return;
  try {
    const res = await fetch(`/api/posts/${pendingDeletePostId}`, { method: "DELETE" });
    if (!res.ok) throw new Error("Delete failed");
    closeDeleteModal();
    loadPosts();
  } catch (err) {
    console.error("Delete error:", err);
    alert("Could not delete post.");
  }
}

// ================= LOAD POSTS FROM DATABASE =================
async function loadPosts() {
  try {
    const res = await fetch("/api/posts");
    const posts = await res.json();

    const recentGrid = document.getElementById("recentPostsGrid");
    const topGrid = document.getElementById("topPostsGrid");
    if (!recentGrid || !topGrid) return;

    recentGrid.innerHTML = "";
    topGrid.innerHTML = "";

    const renderCard = (post) => {
      const postHTML = `
        <div class="post-card">
          <img src="/${post.image}" alt="Post">
          <button class="delete-post-btn" onclick="openDeleteModal(${post.id})" title="Delete post">
            <i class="fa-solid fa-trash"></i>
          </button>
          <div class="post-overlay">
            ${post.caption || ""}
          </div>
        </div>
      `;
      return postHTML;
    };

    posts.forEach(post => {
      recentGrid.insertAdjacentHTML("beforeend", renderCard(post));
    });

    posts.slice(0, 3).forEach(post => {
      topGrid.insertAdjacentHTML("beforeend", renderCard(post));
    });

  } catch (err) {
    console.error("Error loading posts:", err);
  }
}

// ================= INITIAL LOAD =================
loadPosts();

</script>

</body>
</html>
